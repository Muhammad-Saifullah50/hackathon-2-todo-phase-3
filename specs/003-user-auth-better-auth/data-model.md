# Data Model: User Authentication

This document describes the changes to the data model required for User Authentication via Better Auth.

## 1. Better Auth Managed Tables

These tables are managed by the Better Auth library in the Next.js frontend. The FastAPI backend will read from the `user` table.

### `user` Table
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary Key (generated by Better Auth) |
| `email` | String | Unique, User's email address |
| `name` | String | User's full name |
| `emailVerified` | Boolean | Whether the email has been verified |
| `image` | String | URL to user's profile picture |
| `createdAt` | DateTime | Account creation timestamp |
| `updatedAt` | DateTime | Last profile update timestamp |

### `session` Table
Used for managing web sessions.
- `id` (String)
- `userId` (UUID, Foreign Key → user.id)
- `expiresAt` (DateTime)
- `token` (String)
- `createdAt` (DateTime)
- `updatedAt` (DateTime)
- `ipAddress` (String)
- `userAgent` (String)

### `account` Table
Used for linking multiple auth providers (e.g., Email/Password + future Social).
- `id` (String)
- `userId` (UUID, Foreign Key → user.id)
- `accountId` (String)
- `providerId` (String)
- `accessToken` (String)
- `refreshToken` (String)
- `idToken` (String)
- `expiresAt` (DateTime)
- `password` (String) - Encrypted password for email/password provider

## 2. FastAPI SQLModel Updates

### `User` Shadow Model (`backend/src/models/user.py`)
The `User` model will be updated to match the Better Auth table exactly.

```python
class User(SQLModel, table=True):
    __tablename__ = "user"  # Singular to match Better Auth
    __table_args__ = {"extend_existing": True}

    id: UUID = Field(primary_key=True)
    email: str = Field(unique=True, index=True)
    name: str | None = None
    emailVerified: bool = Field(default=False)
    image: str | None = None
    createdAt: datetime = Field(default_factory=datetime.utcnow)
    updatedAt: datetime = Field(default_factory=datetime.utcnow)

    # Relationships
    tasks: list["Task"] = Relationship(back_populates="user", cascade_delete=True)
```

### `Task` Model (`backend/src/models/task.py`)
Ensure the foreign key points to the updated `user` table.

```python
class Task(SQLModel, table=True):
    # ... other fields
    user_id: UUID = Field(foreign_key="user.id")
    user: User = Relationship(back_populates="tasks")
```

## 3. Migration Strategy
- Better Auth will create its tables using its own initialization logic.
- Alembic will be configured to **ignore** these tables in `env.py` to prevent it from attempting to manage or delete them.
- Existing `users` table (plural) will be migrated/renamed to `user` (singular) if data exists, or dropped and recreated.
